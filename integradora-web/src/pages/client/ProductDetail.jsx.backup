import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useProducts } from '../../hooks/useProducts';
import { useCart } from '../../hooks/useCart';
import { useAuth } from '../../hooks/useAuth';
import Loader from '../../components/common/Loader';
import Alert from '../../components/common/Alert';
import ProductReviewsSection from '../../components/product/ProductReviewsSection';

const ProductDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { currentProduct, products, loading, error, fetchProductById, fetchProducts } = useProducts();
  const { addBaseProduct, loading: cartLoading } = useCart();
  const { isAuthenticated, user } = useAuth();

  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [successMessage, setSuccessMessage] = useState('');
  const [initialLoadDone, setInitialLoadDone] = useState(false);

  // Cargar producto actual
  useEffect(() => {
    setSelectedImage(0);
    setQuantity(1);
    fetchProductById(id).catch(err => console.error('Error al cargar producto:', err));
  }, [id]);

  // Cargar lista de productos solo una vez
  useEffect(() => {
    if (!initialLoadDone && (!products || products.length === 0)) {
      fetchProducts().catch(err => console.error('Error al cargar productos:', err));
      setInitialLoadDone(true);
    }
  }, [initialLoadDone, products]);

  const handleAddToCart = async () => {
    if (!isAuthenticated) {
      alert('Debes iniciar sesión para agregar productos al carrito');
      navigate('/login');
      return;
    }

    if (!currentProduct.available) {
      alert('Este producto no está disponible');
      return;
    }

    try {
      await addBaseProduct(currentProduct.id, null, quantity);
      setSuccessMessage(`${currentProduct.name} agregado al carrito`);
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (err) {
      console.error('Error:', err);
      alert('Error al agregar al carrito. Por favor intenta de nuevo.');
    }
  };

  const getImageUrl = (imagePath) => {
    if (!imagePath) return null;
    if (imagePath.startsWith('http')) return imagePath;
    const baseUrl = process.env.REACT_APP_API_URL?.replace('/api', '') || 'http://localhost:8000';
    const cleanPath = imagePath.startsWith('/') ? imagePath : `/${imagePath}`;
    return `${baseUrl}/storage${cleanPath}`;
  };

  if (loading) return <Loader text="Cargando producto..." />;
  if (error) return <Alert type="error" message={error} />;
  if (!currentProduct) return <Alert type="error" message="Producto no encontrado" />;

  const images = currentProduct.images && currentProduct.images.length > 0
    ? currentProduct.images
    : [{ url: currentProduct.image, is_primary: true }];

  const originalPrice = parseFloat(currentProduct.original_price || currentProduct.final_price || 0);
  const finalPrice = parseFloat(currentProduct.final_price || 0);
  const discountPercent = parseFloat(currentProduct.discount_applied || 0);
  const hasDiscount = currentProduct.has_discount === true || (originalPrice > finalPrice && discountPercent > 0);

  return (
    <div className="min-h-screen bg-white">
      {/* Breadcrumb */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <nav className="flex items-center space-x-2 text-sm">
          <button onClick={() => navigate('/')} className="text-gray-500 hover:text-black transition-colors">
            Inicio
          </button>
          <span className="text-gray-400">/</span>
          <button onClick={() => navigate('/shop')} className="text-gray-500 hover:text-black transition-colors">
            Tienda
          </button>
          <span className="text-gray-400">/</span>
          <span className="text-black font-medium">{currentProduct.name}</span>
        </nav>
      </div>

      {/* Success Message */}
      {successMessage && (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-6">
          <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-sm animate-fade-in">
            <div className="flex items-center">
              <svg className="w-5 h-5 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
              <p className="text-green-800 font-medium">{successMessage}</p>
            </div>
          </div>
        </div>
      )}

      {/* Product Detail Section */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">

          {/* Image Gallery */}
          <div className="space-y-4">
            {/* Main Image */}
            <div className="relative aspect-square bg-[#f5f0e8] rounded-2xl overflow-hidden">
              {hasDiscount && discountPercent > 0 && (
                <div className="absolute top-4 right-4 z-10 bg-gradient-to-r from-red-500 to-orange-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">
                  -{discountPercent}%
                </div>
              )}
              <img
                src={getImageUrl(images[selectedImage]?.url)}
                alt={currentProduct.name}
                className="w-full h-full object-cover"
              />
            </div>

            {/* Thumbnail Gallery */}
            {images.length > 1 && (
              <div className="grid grid-cols-4 gap-4">
                {images.map((img, index) => (
                  <button
                    key={index}
                    onClick={() => setSelectedImage(index)}
                    className={`aspect-square rounded-lg overflow-hidden border-2 transition-all ${selectedImage === index
                        ? 'border-black ring-2 ring-black ring-offset-2'
                        : 'border-gray-200 hover:border-gray-400'
                      }`}
                  >
                    <img
                      src={getImageUrl(img.url)}
                      alt={`${currentProduct.name} - ${index + 1}`}
                      className="w-full h-full object-cover"
                    />
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Product Info */}
          <div className="space-y-6">
            <div>
              <h1 className="text-4xl font-bold text-black mb-3 uppercase tracking-tight" style={{ fontFamily: "'Lexend Giga', sans-serif" }}>
                {currentProduct.name}
              </h1>

              {currentProduct.category && (
                <p className="text-sm text-gray-600 uppercase tracking-wide mb-2" style={{ fontFamily: "'Open Sans', sans-serif" }}>
                  {currentProduct.category.name}
                </p>
              )}

              {currentProduct.flavor && (
                <div className="flex items-center gap-2 mb-4">
                  <span className="px-3 py-1 bg-amber-100 text-amber-800 rounded-full text-sm font-medium">
                    {currentProduct.flavor.name}
                  </span>
                  {currentProduct.featured && (
                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                      ⭐ Destacado
                  </>
                )}
              </button>

              <button
                onClick={() => navigate('/shop')}
                className="w-full py-4 rounded-lg border-2 border-black text-black font-bold text-sm uppercase tracking-wide hover:bg-black hover:text-white transition-all"
                style={{ fontFamily: "'Lexend Giga', sans-serif" }}
              >
                Seguir Comprando
              </button>
            </div>

            {/* Additional Info */}
            <div className="border-t border-gray-200 pt-6 space-y-3 text-sm text-gray-600">
              <div className="flex items-center gap-3">
                <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Producto hecho con ingredientes frescos</span>
              </div>
              <div className="flex items-center gap-3">
                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Preparación bajo pedido</span>
              </div>
              <div className="flex items-center gap-3">
                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span>Entrega disponible</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Related Products Section */}
      {products && products.length > 0 && (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 border-t border-gray-200">
          <div className="mb-8">
            <h2 className="text-3xl font-bold text-black uppercase tracking-tight" style={{ fontFamily: "'Lexend Giga', sans-serif" }}>
              Más Productos
            </h2>
            <p className="text-gray-600 mt-2" style={{ fontFamily: "'Open Sans', sans-serif" }}>
              Descubre otros deliciosos productos que podrían interesarte
            </p>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {products
              .filter(p => p.id !== currentProduct.id && p.available)
              .slice(0, 4)
              .map(product => {
                const imageUrl = getImageUrl(product.images?.[0]?.url || product.image);
                const prodOriginalPrice = parseFloat(product.original_price || product.final_price || 0);
                const prodFinalPrice = parseFloat(product.final_price || 0);
                const prodDiscountPercent = parseFloat(product.discount_applied || 0);
                const prodHasDiscount = product.has_discount === true || (prodOriginalPrice > prodFinalPrice && prodDiscountPercent > 0);

                return (
                  <div
                    key={product.id}
                    onClick={() => navigate(`/product/${product.id}`)}
                    className="group relative bg-white rounded-lg overflow-hidden transition-all duration-300 cursor-pointer hover:shadow-lg"
                  >
                    {/* Discount Badge */}
                    {prodHasDiscount && prodDiscountPercent > 0 && (
                      <div className="absolute top-3 right-3 z-10 bg-gradient-to-r from-red-500 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                        -{prodDiscountPercent}%
                      </div>
                    )}

                    {/* Product Image */}
                    <div className="relative w-full aspect-square bg-[#f5f0e8] flex items-center justify-center overflow-hidden">
                      {imageUrl ? (
                        <img
                          src={imageUrl}
                          alt={product.name}
                          className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-95"
                          loading="lazy"
                        />
                      ) : (
                        <svg className="w-32 h-32 text-[#d4c4b0]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.506 2.506 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z" />
                        </svg>
                      )}
                    </div>

                    {/* Product Info */}
                    <div className="p-4 bg-white">
                      <h3 className="text-sm font-bold text-black mb-1 uppercase tracking-wide leading-tight line-clamp-2" style={{ fontFamily: "'Lexend Giga', sans-serif" }}>
                        {product.name}
                      </h3>

                      <p className="text-xs text-gray-600 mb-2 line-clamp-1" style={{ fontFamily: "'Open Sans', sans-serif" }}>
                        {product.flavor?.name || 'Delicioso pastel'}
                      </p>

                      {/* Price Section */}
                      <div className="flex items-center gap-2">
                        <span className="text-xl font-bold text-black" style={{ fontFamily: "'Lexend Giga', sans-serif" }}>
                          ${prodFinalPrice.toFixed(2)}
                        </span>

                        {prodHasDiscount && prodOriginalPrice > prodFinalPrice && (
                          <span className="text-sm font-medium text-gray-400 line-through" style={{ fontFamily: "'Lexend Giga', sans-serif" }}>
                            ${prodOriginalPrice.toFixed(2)}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>

          {/* Ver Todos Button */}
          <div className="text-center mt-8">
            <button
              onClick={() => navigate('/shop')}
              className="inline-flex items-center px-8 py-3 bg-black text-white font-bold text-sm uppercase tracking-wide rounded-lg hover:bg-gray-800 transition-all"
              style={{ fontFamily: "'Lexend Giga', sans-serif" }}
            >
              Ver Todos Los Productos
              <svg className="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </button>
          </div>
        </div>
      )}

      {/* Reviews Section */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 border-t border-gray-200">
        <ProductReviewsSection
          productId={currentProduct.id}
          userId={user?.id || null}
        />
      </div>
    </div>
  );
};

export default ProductDetail;